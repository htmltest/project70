<div class="mortgage-forms">
    <div class="mortgage-params">
        <div class="mortgage-params-title">Расчитайте свою ипотеку</div>

        <form action="#" method="post">

            <div class="mortgage-param">
                <div class="mortgage-param-label">Стоимость квартиры</div>
                <div class="mortgage-param-field" id="price">
                    <div class="mortgage-param-input"><input type="text" name="price" value="5300250" /></div>
                    <div class="mortgage-param-value"><span></span><em>&#8381;</em></div>
                    <div class="mortgage-param-slider">
                        <div class="range"></div>
                    </div>
                </div>
            </div>

            <div class="mortgage-param">
                <div class="mortgage-param-label">Первоначальный взнос <span>/ не менее 20%</span> <div class="mortgage-initial-summ"><strong></strong> &#8381;</div></div>
                <div class="mortgage-param-field" id="initial">
                    <div class="mortgage-param-input"><input type="text" name="initial" value="40" /></div>
                    <div class="mortgage-param-value"><span></span><em>%</em></div>
                    <div class="mortgage-param-slider">
                        <div class="range"></div>
                    </div>
                </div>
            </div>

            <div class="mortgage-param">
                <div class="mortgage-param-label">Процентная ставка</div>
                <div class="mortgage-param-field" id="rate">
                    <div class="mortgage-param-input"><input type="text" name="rate" value="11.4" readonly="true" /></div>
                    <div class="mortgage-param-value"><span></span><em>%</em></div>
                    <div class="mortgage-param-slider">
                        <div class="range"></div>
                    </div>
                </div>
            </div>

            <div class="mortgage-param">
                <div class="mortgage-param-label">Срок ипотеки <span>/ не менее 12 месяцев</span> <div class="mortgage-period-summ"></div></div>
                <div class="mortgage-param-field" id="period">
                    <div class="mortgage-param-input"><input type="text" name="period" value="90" readonly="true" /></div>
                    <div class="mortgage-param-value"><span></span><em>месяцев</em></div>
                    <div class="mortgage-param-slider">
                        <div class="range"></div>
                    </div>
                </div>
            </div>

            <script>
                $('#price').each(function() {
                    var curSlider = $(this);
                    var curRange = curSlider.find('.range')[0];
                    noUiSlider.create(curRange, {
                        start: [Number(curSlider.find('.mortgage-param-input input').val())],
                        connect: [true, false],
                        range: {
                            'min': 3000000,
                            'max': 8000000
                        },
                        format: wNumb({
                            decimals: 0
                        }),
                        pips: {
                            mode: 'positions',
                            values: [0, 25, 50, 75, 100],
                            density: 100,
                            format: wNumb({
                                decimals: 1,
                                postfix: ' млн',
                                encoder: function(value) {
                                    return value / 1000000
                                }
                            })
                        }
                    });
                    curRange.noUiSlider.on('update', function(values, handle) {
                        curSlider.find('.mortgage-param-input input').val(values[handle]);
                        curSlider.find('.mortgage-param-value span').html(String(values[handle]).replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g, '$1 '));
                        var curSumm = Math.round($('#initial').find('.mortgage-param-input input').val() / 100 * values[handle]);
                        $('.mortgage-initial-summ strong').html(String(curSumm).replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g, '$1 '));
                        recalcMortgage();
                    });
                });

                $('#initial').each(function() {
                    var curSlider = $(this);
                    var curRange = curSlider.find('.range')[0];
                    noUiSlider.create(curRange, {
                        start: [Number(curSlider.find('.mortgage-param-input input').val())],
                        step: 1,
                        connect: [true, false],
                        range: {
                            'min': 20,
                            'max': 80
                        },
                        format: wNumb({
                            decimals: 0
                        }),
                        pips: {
                            mode: 'positions',
                            values: [0, 25, 50, 75, 100],
                            format: wNumb({
                                decimals: 0,
                                postfix: '%'
                            })
                        }
                    });
                    curRange.noUiSlider.on('update', function(values, handle) {
                        curSlider.find('.mortgage-param-input input').val(values[handle]);
                        curSlider.find('.mortgage-param-value span').html(values[handle]);
                        var curSumm = Math.round(values[handle] / 100 * $('#price').find('.mortgage-param-input input').val());
                        $('.mortgage-initial-summ strong').html(String(curSumm).replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g, '$1 '));
                        recalcMortgage();
                    });
                });

                $('#rate').each(function() {
                    var curSlider = $(this);
                    var curRange = curSlider.find('.range')[0];
                    noUiSlider.create(curRange, {
                        start: [Number(curSlider.find('.mortgage-param-input input').val())],
                        step: 0.1,
                        connect: [true, false],
                        range: {
                            'min': 9,
                            'max': 13
                        },
                        format: wNumb({
                            decimals: 1
                        }),
                        pips: {
                            mode: 'positions',
                            values: [0, 25, 50, 75, 100],
                            format: wNumb({
                                decimals: 0,
                                postfix: '%'
                            })
                        }
                    });
                    curRange.noUiSlider.on('update', function(values, handle) {
                        curSlider.find('.mortgage-param-input input').val(values[handle]);
                        curSlider.find('.mortgage-param-value span').html(values[handle]);
                        recalcMortgage();
                    });
                });

                $('#period').each(function() {
                    var curSlider = $(this);
                    var curRange = curSlider.find('.range')[0];
                    noUiSlider.create(curRange, {
                        start: [Number(curSlider.find('.mortgage-param-input input').val())],
                        step: 1,
                        connect: [true, false],
                        range: {
                            'min': 12,
                            'max': 360
                        },
                        format: wNumb({
                            decimals: 0
                        }),
                        pips: {
                            mode: 'values',
                            values: [12, 90, 180, 270, 360],
                            format: wNumb({
                                decimals: 0
                            })
                        }
                    });
                    curRange.noUiSlider.on('update', function(values, handle) {
                        curSlider.find('.mortgage-param-input input').val(values[handle]);
                        curSlider.find('.mortgage-param-value span').html(values[handle]);

                        function num_ending(number) {
                            var endings = Array('лет', 'год', 'года');
                            var num100 = number % 100;
                            var num10 = number % 10;
                            if (num100 >= 5 && num100 <= 20) {
                                return endings[0];
                            } else if (num10 == 0) {
                                return endings[0];
                            } else if (num10 == 1) {
                                return endings[1];
                            } else if (num10 >= 2 && num10 <= 4) {
                                return endings[2];
                            } else if (num10 >= 5 && num10 <= 9) {
                                return endings[0];
                            } else {
                                return endings[2];
                            }
                        }

                        var Format = wNumb({
                            decimals: 1,
                            mark: ','
                        });

                        var curYear = values[handle] / 12;
                        $('.mortgage-period-summ').html(Format.to(curYear) + ' ' + num_ending(Math.floor(curYear)));
                        recalcMortgage();
                    });
                });

                function recalcMortgage() {
                    var price   = Number($('#price').find('.mortgage-param-input input').val());
                    var initial = Number($('#initial').find('.mortgage-param-input input').val());
                    var rate    = Number($('#rate').find('.mortgage-param-input input').val()) / 100 / 12;
                    var period  = Number($('#period').find('.mortgage-param-input input').val());

                    var creditSumm          = price - Math.round(initial / 100 * price);
                    var creditPayment       = Math.round(creditSumm * (rate / (1 - Math.pow((1 + rate), -period))));
                    var creditIncome        = Math.round(creditPayment * 100 / 50);
                    var creditOverpayment   = creditPayment * period - creditSumm;

                    $('#credit-summ').html(String(creditSumm).replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g, '$1 '));
                    $('#credit-payment').html(String(creditPayment).replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g, '$1 '));
                    $('#credit-income').html(String(creditIncome).replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g, '$1 '));
                    $('#credit-overpayment').html(String(creditOverpayment).replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g, '$1 '));
                }
            </script>

        </form>
    </div>

    <div class="mortgage-results">
        <div class="mortgage-results-title">Ваше предложение</div>

        <div class="mortgage-results-label">Размер кредита</div>
        <div class="mortgage-results-value mortgage-results-value-summ"><span id="credit-summ"></span> &#8381;</div>

        <div class="mortgage-results-label">Ежемесячный платеж</div>
        <div class="mortgage-results-value"><span id="credit-payment"></span> &#8381;</div>

        <div class="mortgage-results-label">Необходимый доход</div>
        <div class="mortgage-results-value"><span id="credit-income"></span> &#8381;</div>

        <div class="mortgage-results-label">Переплата</div>
        <div class="mortgage-results-value"><span id="credit-overpayment"></span> &#8381;</div>

        <div class="mortgage-results-form mortgage-results-form-2">
            <a href="#" class="mortgage-results-form-link detail-link">отправить заявку</a>
            <form action="windows/success.html" method="post">
                <a href="#" class="mortgage-results-form-close"></a>
                <div class="mortgage-results-form-title">Отправить заявку<br />на ипотеку</div>

                <div class="form-label">ФИО</div>
                <div class="form-input"><input type="text" name="name" value="" class="required" /></div>

                <div class="form-label">Телефон</div>
                <div class="form-input"><input type="text" name="phone" value="" class="required maskPhone" placeholder="+7 ( ___ ) ___-__-__" /></div>

                <div class="form-label">Адрес электронной почты</div>
                <div class="form-input"><input type="text" name="email" value="" class="required email" /></div>

                <div class="form-submit"><input type="submit" value="Отправить заявку" /></div>

                <a href="#" class="mortgage-results-form-close-link">Свернуть</a>
            </form>
        </div>

        <div class="mortgage-results-form">
            <a href="#" class="mortgage-results-form-link detail-link">Клиенту на почту</a>
            <form action="windows/success.html" method="post">
                <a href="#" class="mortgage-results-form-close"></a>
                <div class="mortgage-results-form-title">Отправить клиенту<br />на почту</div>

                <div class="form-label">Адрес электронной почты</div>
                <div class="form-input"><input type="text" name="email" value="" class="required email" /></div>

                <div class="form-submit"><input type="submit" value="Отправить" /></div>

                <a href="#" class="mortgage-results-form-close-link">Свернуть</a>
            </form>
        </div>
    </div>
</div>